<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --hex-width: 32px;
      --hex-height: 24px;
    }

    body {
      -webkit-font-smoothing: none;
      image-rendering: pixelated;
      /* zoom: 2; */
    }

    #main {
      height: 144px;
      width: 300px;
      padding: 16px 0 0 44px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: absolute;
      top: 0;
      left: 0;
    }

    #message {
      height: 80px;
      width: 320px;
      background-color: lightgreen;
    }

    .hex::before {
      background-color: lightgray;
      width: calc(var(--hex-width) - 1px);
      height: calc(var(--hex-height) - 1px);
      clip-path: polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%);
      position: absolute;
      content: '';
      /* top: 1px;
      left: 1px; */
    }

    .hex {
      background-color: black;
      width: var(--hex-width);
      height: var(--hex-height);
      clip-path: polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%);
      position: relative;
    }

    .hidden {
      background-color: transparent;
    }

    .hidden::before {
      background-color: transparent;
    }

    #container {
      display: flex;
      flex-direction: column;
      width: 320px;
      height: 240px;
      background-color: lightblue;
    }

    .row {
      display: flex;
      column-gap: calc(var(--hex-width) / 2);
      width: 280px;
    }

    .row:nth-child(even) {
      margin-left: calc(var(--hex-width) * 0.75);
    }

    .row:not(:first-child) {
      margin-top: calc(var(--hex-height) / -2);
    }

    .wrapper {
      position: relative;
      width: 320px;
      height: 160px;
    }

    .cursor {
      position: absolute;
      top: 0;
      left: 0;
      width: 1em;
      height: 1em;
      color: red;
    }
  </style>
  <title>プロトタイプ</title>
</head>

<body>
  <div id="container">
    <div class="wrapper">
      <div id="main">
        <div class="row" v-for="y in row">
          <div class="hex" v-for="x in column" :data-x="x" :data-y="y" :class="{
          hidden: isHidden(x, y)
        }"></div>
        </div>
      </div>
      <div class="cursor" :style="{
      top: cursorY * 24 * 0.5 + 'px',
      left: cursorX * 32 * 1.5 + cursorY % 2 * 32 * 0.75 + 52 + 'px'
    }">▼</div>
    </div>
    <div id="message">
      test: {{cursorX}}, {{cursorY}}<br />
      <span v-for="k in keyList">{{k}}&nbsp;</span>
    </div>
  </div>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

  <script>
    const { createApp, ref } = Vue;

    createApp({
      setup() {
        const row = 9;
        const column = 5;
        const keyViewTime = 1000;
        const cursorX = ref(1);
        const cursorY = ref(0);
        const keyList = ref([]);
        let isBottom = false;
        let isTop = true;

        const isHidden = (x, y) => {
          // まず、右端を削る
          if (x === column && y % 2 == 0) {
            return true;
          }
          // 左上
          if (x === 1 && y === 1) {
            return true;
          }
          // 右上
          if (x === column && y === 1) {
            return true;
          }
          // 左下
          if (x === 1 && y === row) {
            return true;
          }
          // 右下
          if (x === column && y === row) {
            return true;
          }
          return false;
        }

        const removeKey = () => {
          keyList.value.pop();
        }

        const onKeyDown = (e) => {
          switch (e.key) {
            case "ArrowUp":
              keyList.value.unshift('↑');
              setTimeout(removeKey, keyViewTime);
              isBottom = false;
              cursorY.value -= 2;
              if (cursorY.value < 0) {
                cursorY.value = row - 1 + cursorY.value % 2;
              }
              // 四隅対応
              if (cursorX.value === 0 || cursorX.value == column - 1) {
                if (cursorY.value < 2) {
                  cursorY.value = row - 3;
                }
              }
              break;
            case "ArrowDown":
              keyList.value.unshift('↓');
              setTimeout(removeKey, keyViewTime);
              isBottom = false;
              cursorY.value += 2;
              if (cursorY.value > row - 1) {
                cursorY.value = 0 + cursorY.value % 2;
              }
              // 四隅対応
              if (cursorX.value === 0 || cursorX.value == column - 1) {
                if (cursorY.value > row - 3) {
                  cursorY.value = 2;
                }
              }
              break;
            case "ArrowLeft":
              keyList.value.unshift('←');
              setTimeout(removeKey, keyViewTime);
              if (cursorY.value === row - 1) {
                isBottom = true;
              }
              if (cursorY.value === 0) {
                isTop = true;
              }
              // 四隅対応
              if (isBottom || isTop) {
                if (cursorX.value === 0 && cursorY.value === 1
                  || cursorX.value === 0 && cursorY.value === row - 2
                ) {
                  cursorX.value = column - 2;
                  break;
                }
              }
              if (cursorY.value % 2 === 0) {
                // 奇数行の場合
                cursorX.value--;
                if (cursorX.value < 0) {
                  cursorX.value = column - 1;
                } else if (isBottom) {
                  cursorY.value--;
                } else {
                  cursorY.value++;
                }
              }
              else {
                // 偶数行の場合
                if (isBottom) {
                  cursorY.value++;
                } else {
                  cursorY.value--;
                }
              }
              break;
            case "ArrowRight":
              keyList.value.unshift('→');
              setTimeout(removeKey, keyViewTime);
              if (cursorY.value === row - 1) {
                isBottom = true;
              }
              if (cursorY.value === 0) {
                isTop = true;
              }
              // 四隅対応
              if (isBottom || isTop) {
                if (cursorX.value === column - 2 && cursorY.value === 1
                  || cursorX.value === column - 2 && cursorY.value === row - 2
                ) {
                  cursorX.value = 0;
                  break;
                }
              }
              if (cursorY.value % 2 === 0) {
                // 奇数行の場合
                if (cursorX.value === column - 1) {
                  // 反転する
                  cursorX.value = 0;
                } else if (isBottom) {
                  // 最下段での移動の場合
                  cursorY.value--;
                } else {
                  cursorY.value++;
                }
              }
              else {
                // 偶数行の場合
                cursorX.value++;
                if (isBottom) {
                  cursorY.value++;
                } else {
                  cursorY.value--;
                }
              }
              break;
            default:
              break;
          }
        }
        return {
          row,
          column,
          cursorX,
          cursorY,
          onKeyDown,
          isHidden,
          keyList
        }
      },
      mounted() {
        document.addEventListener('keydown', this.onKeyDown);
      },
      beforeUnmount() {
        document.removeEventListener('keydown', this.onKeyDown);
      }
    }).mount('#container');
  </script>
</body>

</html>